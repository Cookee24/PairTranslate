name: üöÄ Publish Extension to Stores

on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v5

      - name: üõ†Ô∏è Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: "22"

      - name: üõ†Ô∏è Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: üì¶ Install Dependencies
        run: bun install --frozen-lockfile

      - name: üèóÔ∏è Build Extension
        run: bun run build

      - name: üíæ Create Store Zips
        run: |
          bun run zip
          bun run zip:firefox

      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: .output/*.zip

      - name: ‚¨ÜÔ∏è Submit to All Stores (Chrome, Firefox, Edge)
        run: bunx wxt submit \
          --chrome-zip .output/*-chrome.zip \
          --firefox-zip .output/*-firefox.zip \
          --firefox-sources-zip .output/*-sources.zip \
          --edge-zip .output/*-chrome.zip

        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}

          FIREFOX_EXTENSION_ID: ${{ secrets.FIREFOX_EXTENSION_ID }}
          FIREFOX_JWT_ISSUER: ${{ secrets.FIREFOX_JWT_ISSUER }}
          FIREFOX_JWT_SECRET: ${{ secrets.FIREFOX_JWT_SECRET }}

          EDGE_PRODUCT_ID: ${{ secrets.EDGE_PRODUCT_ID }}
          EDGE_CLIENT_ID: ${{ secrets.EDGE_CLIENT_ID }}
          EDGE_CLIENT_SECRET: ${{ secrets.EDGE_CLIENT_SECRET }}
          EDGE_ACCESS_TOKEN: ${{ secrets.EDGE_ACCESS_TOKEN }}
